<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Procesando login...</title>
    <script>
        const config = {
            issuer: 'https://apitest.um.es/mncs/api-umu/cas/oidc',
            clientId: 'webservice',
            redirectUri: window.location.origin + '/callback.html',
            scope: 'openid profile email'
        };

        async function base64UrlEncode(buffer) {
            return btoa(String.fromCharCode(...new Uint8Array(buffer)))
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=+$/, '');
        }

        async function sha256(buffer) {
            return await crypto.subtle.digest('SHA-256', buffer);
        }

        async function generateCodeChallenge(codeVerifier) {
            const encoded = new TextEncoder().encode(codeVerifier);
            const hash = await sha256(encoded);
            return base64UrlEncode(hash);
        }

        function generateRandomString(length) {
            const array = new Uint8Array(length);
            crypto.getRandomValues(array);
            return base64UrlEncode(array);
        }

        async function exchangeCodeForTokens(code, codeVerifier) {
            const params = new URLSearchParams({
                grant_type: 'authorization_code',
                client_id: config.clientId,
                code: code,
                redirect_uri: config.redirectUri,
                code_verifier: codeVerifier
            });

            const tokenUrl = config.issuer + '/token';
            
            const response = await fetch(tokenUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error('Error al intercambiar código: ' + errorText);
            }

            return await response.json();
        }

        async function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');

            if (error) {
                document.body.innerHTML = '<h1>Error: ' + error + '</h1><p>' + urlParams.get('error_description') + '</p><a href="/login.html">Volver</a>';
                return;
            }

            if (!code) {
                document.body.innerHTML = '<h1>No se recibió código de autorización</h1><a href="/login.html">Volver</a>';
                return;
            }

            const codeVerifier = sessionStorage.getItem('oidc_code_verifier');
            sessionStorage.removeItem('oidc_code_verifier');

            if (!codeVerifier) {
                document.body.innerHTML = '<h1>Error: No se encontró code verifier</h1><a href="/login.html">Volver</a>';
                return;
            }

            try {
                const tokens = await exchangeCodeForTokens(code, codeVerifier);
                
                sessionStorage.setItem('oidc_access_token', tokens.access_token);
                if (tokens.id_token) {
                    sessionStorage.setItem('oidc_id_token', tokens.id_token);
                }
                if (tokens.refresh_token) {
                    sessionStorage.setItem('oidc_refresh_token', tokens.refresh_token);
                }
                sessionStorage.setItem('oidc_token_type', tokens.token_type);
                sessionStorage.setItem('oidc_expires_at', Date.now() + (tokens.expires_in * 1000));

                window.location.href = '/app.html';
            } catch (err) {
                document.body.innerHTML = '<h1>Error al obtener tokens</h1><p>' + err.message + '</p><a href="/login.html">Volver</a>';
            }
        }

        window.onload = handleCallback

    </script>
</head>
<body>
    <h1>Procesando autenticación...</h1>
</body>
</html>
